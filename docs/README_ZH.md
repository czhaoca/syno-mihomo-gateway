# Syno-Mihomo-Gateway (ç¾¤æ™– DSM é€æ˜ç½‘å…³)

[English Docs](README.md)

è¿™æ˜¯ä¸€ä¸ªåŸºäº Docker çš„ **Mihomo (Clash Meta)** é€æ˜ç½‘å…³ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆï¼Œä¸“ä¸ºç¾¤æ™– (Synology DSM) è®¾è®¡ã€‚
é€šè¿‡æ­¤æ–¹æ¡ˆï¼Œä½ å¯ä»¥è®©å®¶ä¸­çš„ä»»ä½•è®¾å¤‡ï¼ˆApple TV, iPhone, PS5, Switchï¼‰é€šè¿‡ç®€å•çš„ç½‘å…³è®¾ç½®å®ç°ç§‘å­¦ä¸Šç½‘ï¼Œæ— éœ€åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šå®‰è£…è½¯ä»¶ã€‚

## åŠŸèƒ½ç‰¹ç‚¹
- ğŸš€ **è‡ªåŠ¨åŒ–è„šæœ¬:** è‡ªåŠ¨æ£€æµ‹ç¾¤æ™–ç½‘ç»œæ¥å£ï¼ˆå®Œç¾æ”¯æŒ Open vSwitch `ovs_eth0` ç¯å¢ƒï¼‰ã€‚
- ğŸ›¡ï¸ **å®‰å…¨éš”ç¦»:** ä½¿ç”¨ Docker Macvlan æ¨¡å¼ï¼Œæ‹¥æœ‰ç‹¬ç«‹ IPï¼Œä¸å¹²æ‰°ç¾¤æ™–å®¿ä¸»æœºç½‘ç»œã€‚
- ğŸ”§ **é…ç½®ç®€å•:** é€šè¿‡ `.env` æ–‡ä»¶å³å¯é…ç½® IPã€å­ç½‘å’Œç«¯å£ã€‚
- ğŸ” **è®¢é˜…åˆ†ç¦»:** è®¢é˜…é“¾æ¥ä¿å­˜åœ¨ç‹¬ç«‹çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œæ›´æ–°è®¢é˜…æ— éœ€ä¿®æ”¹å¤æ‚é…ç½®æ–‡ä»¶ã€‚

---

## å‡†å¤‡å·¥ä½œ
1.  **ç¾¤æ™– NAS** (éœ€æ”¯æŒ Docker/Container Manager)ã€‚
2.  **å¼€å¯ SSH** (æ§åˆ¶é¢æ¿ -> ç»ˆç«¯æœºå’Œ SNMP)ã€‚
3.  **Root æƒé™** (éœ€è¦ sudo æƒé™æ¥åˆ›å»ºç½‘ç»œæ¥å£)ã€‚

---

## å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½ä»£ç ä»“åº“
SSH ç™»å½•ç¾¤æ™–ï¼Œè¿›å…¥ Docker ç›®å½•ï¼š
```bash
cd /volume1/docker
git clone https://github.com/czhaoca/syno-mihomo-gateway.git
cd syno-mihomo-gateway

```

### 2. ä¿®æ”¹é…ç½®

å¤åˆ¶æ¨¡æ¿æ–‡ä»¶å¹¶ä¿®æ”¹ï¼š

```bash
cp .env.example .env
vi .env

```

* **ROUTER_IP:** ä½ çš„ä¸»è·¯ç”±å™¨ IP (ä¾‹å¦‚ `192.168.1.1`)ã€‚
* **MIHOMO_IP:** ä½ æƒ³ç»™æ—è·¯ç”±åˆ†é…çš„ IP (ä¾‹å¦‚ `192.168.1.100`, å¿…é¡»æ˜¯ç©ºé—² IP)ã€‚

*   **DOCKER_REGISTRY (å¯é€‰):** å¦‚æœæ‚¨åœ¨ Docker Hub è®¿é—®å—é™çš„ç¯å¢ƒä¸­ï¼ˆä¾‹å¦‚ä¸­å›½å¤§é™†ï¼‰æˆ–ä½¿ç”¨ç§æœ‰ä»“åº“ï¼Œè¯·å°†å…¶è®¾ç½®ä¸ºæ‚¨çš„é•œåƒä»“åº“åœ°å€ï¼ˆä¾‹å¦‚ `registry.cn-shenzhen.aliyuncs.com`ï¼‰ã€‚
*   **DOCKER_USERNAME (å¯é€‰):** æ‚¨çš„ Docker é•œåƒä»“åº“ç”¨æˆ·åã€‚å¦‚æœæ­¤é¡¹ç•™ç©ºä¸” `DOCKER_REGISTRY` å·²è®¾ç½®ï¼Œå®‰è£…è„šæœ¬å°†æç¤ºæ‚¨è¾“å…¥ã€‚
*   **MIHOMO_IMAGE (å¯é€‰):** Mihomo çš„å®Œæ•´é•œåƒè·¯å¾„ï¼ˆä¾‹å¦‚ `registry.cn-shenzhen.aliyuncs.com/your_name/mihomo:latest`ï¼‰ã€‚é»˜è®¤å€¼ä¸º `metacubex/mihomo:latest`ã€‚
*   **METACUBEXD_IMAGE (å¯é€‰):** Metacubexd UI çš„å®Œæ•´é•œåƒè·¯å¾„ï¼ˆä¾‹å¦‚ `registry.cn-shenzhen.aliyuncs.com/your_name/metacubexd:latest`ï¼‰ã€‚é»˜è®¤å€¼ä¸º `ghcr.io/metacubex/metacubexd:latest`ã€‚

### 3. æ·»åŠ è®¢é˜…

ç¼–è¾‘è®¢é˜…æ–‡ä»¶ï¼š

```bash
vi config/subscription.txt

```

å¡«å…¥ä½ çš„æœºåœºè®¢é˜…é“¾æ¥ (æ ¼å¼: `åå­—=é“¾æ¥`ï¼Œç›®å‰è„šæœ¬ä»…è¯»å–ç¬¬ä¸€è¡Œé“¾æ¥):

```text
Default=[https://your-provider.com/api/v1/subscribe?token=123](https://your-provider.com/api/v1/subscribe?token=123)...

```

### 4. è¿è¡Œåˆå§‹åŒ–è„šæœ¬

æ­¤è„šæœ¬ä¼šè‡ªåŠ¨å¼€å¯ TUN æƒé™ã€åˆ›å»º Macvlan ç½‘ç»œï¼Œå¹¶æ ¹æ®æ‚¨çš„ `.env` é…ç½®ï¼Œé€‰æ‹©æ€§åœ°å¤„ç† Docker é•œåƒä»“åº“ç™»å½•å’Œé•œåƒæ‹‰å–ã€‚

```bash
sudo chmod +x scripts/setup_network.sh
sudo ./scripts/setup_network.sh

```

### 5. å¯åŠ¨å®¹å™¨

```bash
sudo docker-compose up -d

```

### 6. è¿›å…¥åå°ç®¡ç†

* æµè§ˆå™¨è®¿é—®: `http://ç¾¤æ™–IP:8080` (æ³¨æ„æ˜¯ç¾¤æ™–çš„ IP)
* æ·»åŠ åç«¯ (Backend):
* **Host:** `ä½ çš„MIHOMO_IP` (ä¾‹å¦‚ `192.168.1.100`)
* **Port:** `9090`



---

## å®¢æˆ·ç«¯è®¾ç½® (å¦‚ä½•ä½¿ç”¨)

### æ–¹æ³• A: å•è®¾å¤‡æ¨¡å¼ (æ¨è)

åœ¨ iPhone, Apple TV æˆ– ç”µè„‘çš„ç½‘ç»œè®¾ç½®ä¸­ï¼š

1. å°† **è·¯ç”±å™¨ / ç½‘å…³ (Router/Gateway)** ä¿®æ”¹ä¸º `192.168.1.100`ã€‚
2. å°† **DNS** ä¿®æ”¹ä¸º `192.168.1.100`ã€‚

### æ–¹æ³• B: å…¨å±‹æ¨¡å¼ (è¿›é˜¶)

åœ¨ä¸»è·¯ç”±å™¨çš„ DHCP è®¾ç½®ä¸­ï¼Œå°†é»˜è®¤ç½‘å…³ä¿®æ”¹ä¸º `192.168.1.100`ã€‚
**æ³¨æ„:** å¦‚æœå®¹å™¨åœæ­¢è¿è¡Œï¼Œå…¨å±‹ç½‘ç»œå°†ä¸­æ–­ã€‚

---

## ç»´æŠ¤ä¸æ›´æ–°

**æ›´æ–°è®¢é˜…:**

1. ä¿®æ”¹ `config/subscription.txt`ã€‚
2. é‡å¯å®¹å™¨: `docker-compose restart mihomo`ã€‚

**æ›´æ–°å†…æ ¸:**

```bash
docker-compose pull
docker-compose up -d

```
